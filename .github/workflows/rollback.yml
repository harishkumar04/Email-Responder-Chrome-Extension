name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to rollback to'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Validate commit SHA
      run: |
        if git cat-file -e ${{ github.event.inputs.commit_sha }}^{commit}; then
          echo "‚úÖ Commit SHA is valid"
        else
          echo "‚ùå Invalid commit SHA"
          exit 1
        fi
    
    - name: Create rollback branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b rollback-$(date +%Y%m%d-%H%M%S)
        git reset --hard ${{ github.event.inputs.commit_sha }}
    
    - name: Test rollback version
      run: |
        python -c "
        try:
            from main import app
            print('‚úÖ Rollback version works correctly')
        except Exception as e:
            print(f'‚ùå Rollback version has issues: {e}')
            exit(1)
        "
    
    - name: Push rollback branch
      run: |
        git push origin HEAD
        echo "üîÑ Rollback branch created successfully"
        echo "üìã Next steps:"
        echo "1. Create PR from rollback branch to main"
        echo "2. Review and merge the rollback PR"
        echo "3. Verify production is working correctly"
