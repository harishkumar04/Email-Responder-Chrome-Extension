name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8 black isort mypy
    
    - name: Code formatting check (Black)
      run: black --check --diff .
    
    - name: Import sorting check (isort)
      run: isort --check-only --diff .
    
    - name: Lint with flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Type checking with mypy
      run: mypy main.py --ignore-missing-imports
      continue-on-error: true
    
    - name: Test FastAPI app startup
      run: |
        python -c "
        import sys
        sys.path.append('.')
        try:
            from main import app
            print('‚úÖ FastAPI app imports successfully')
        except Exception as e:
            print(f'‚ùå FastAPI app import failed: {e}')
            sys.exit(1)
        "
    
    - name: Test environment loading
      run: |
        python -c "
        import os
        from dotenv import load_dotenv
        load_dotenv()
        print('‚úÖ Environment loading works')
        "
    
    - name: Run basic tests
      run: |
        python -c "
        import hashlib
        import time
        from main import get_cache_key, response_cache, CACHE_TTL
        
        # Test cache key generation
        key1 = get_cache_key('test email', 'professional')
        key2 = get_cache_key('test email', 'professional')
        key3 = get_cache_key('different email', 'professional')
        
        assert key1 == key2, 'Same input should generate same key'
        assert key1 != key3, 'Different input should generate different key'
        assert len(key1) == 32, 'MD5 hash should be 32 characters'
        
        print('‚úÖ Cache key generation tests passed')
        print('‚úÖ All basic tests passed')
        "

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security scan
      uses: pypa/gh-action-pip-audit@v1.0.8
      with:
        inputs: requirements.txt

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test Docker build
      run: |
        if [ -f Dockerfile ]; then
          docker build -t email-responder-test .
          echo "‚úÖ Docker build successful"
        else
          echo "‚ö†Ô∏è No Dockerfile found, skipping Docker build"
        fi

  branch-protection:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check PR requirements
      run: |
        echo "‚úÖ PR created - running all checks"
        echo "üìã Checks required before merge:"
        echo "  - Code formatting (Black)"
        echo "  - Import sorting (isort)" 
        echo "  - Linting (flake8)"
        echo "  - Type checking (mypy)"
        echo "  - FastAPI app startup test"
        echo "  - Basic functionality tests"
        echo "  - Security scan"
        echo "  - Docker build test"
